name: Mirror Repository to Element's GitHub Repo

on: 
  push:
  pull_request:
    branches: [ main ]
jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
        eval $(ssh-agent -s)
        ssh-add ~/.ssh/id_rsa

    - name: Install git-filter-repo
      run: |
        sudo apt-get update
        sudo apt-get install -y git-filter-repo

    - name: Filter out the workflow directory
      run: |
        git filter-repo --invert-paths --path-glob '.github/workflows/mirror.yml'

    - name: Mirror the Repository without workflow files
      run: |
        git push --mirror git@github.com:EFM-Digital/enterprise-apis.git

    - name: Cleanup SSH Agent
      if: always()
      run: |
        eval $(ssh-agent -s)
        ssh-agent -k
